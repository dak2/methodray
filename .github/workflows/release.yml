name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-native:
    name: Build (${{ matrix.ruby-platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            ruby-platform: x86_64-linux
            rust-target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            ruby-platform: aarch64-linux
            rust-target: aarch64-unknown-linux-gnu
            use-cross: true
          - os: macos-13
            ruby-platform: x86_64-darwin
            rust-target: x86_64-apple-darwin
          - os: macos-14
            ruby-platform: arm64-darwin
            rust-target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build CLI binary
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cd ext && cross build --release --features cli --bin methodray-cli --target ${{ matrix.rust-target }}
          else
            cd ext && cargo build --release --features cli --bin methodray-cli --target ${{ matrix.rust-target }}
          fi

      - name: Build FFI extension
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cd ext && cross build --release --lib --target ${{ matrix.rust-target }}
          else
            cd ext && cargo build --release --lib --target ${{ matrix.rust-target }}
          fi

      - name: Copy binaries to lib directory
        run: |
          mkdir -p lib/methodray
          # Copy CLI binary
          if [[ "${{ matrix.rust-target }}" == *"windows"* ]]; then
            cp target/${{ matrix.rust-target }}/release/methodray-cli.exe lib/methodray/
          else
            cp target/${{ matrix.rust-target }}/release/methodray-cli lib/methodray/
          fi
          chmod 755 lib/methodray/methodray-cli* || true
          # Copy FFI extension
          case "${{ matrix.ruby-platform }}" in
            *-darwin)
              cp target/${{ matrix.rust-target }}/release/libmethodray.dylib lib/methodray/methodray.bundle
              ;;
            *-linux)
              cp target/${{ matrix.rust-target }}/release/libmethodray.so lib/methodray/methodray.so
              ;;
          esac
          ls -la lib/methodray/

      - name: Build platform gem
        run: |
          # Create platform-specific gemspec
          cat > methodray-${{ matrix.ruby-platform }}.gemspec << 'EOF'
          require_relative 'lib/methodray/version'
          Gem::Specification.new do |spec|
            spec.name          = 'method-ray'
            spec.version       = MethodRay::VERSION
            spec.platform      = '${{ matrix.ruby-platform }}'
            spec.authors       = ['dak2']
            spec.email         = ['dak2.dev@gmail.com']
            spec.summary       = 'Method-Ray is a fast static analysis tool for Ruby methods.'
            spec.description   = 'A static analysis tool that checks the callability of methods in Ruby code.'
            spec.homepage      = 'https://github.com/dak2/method-ray'
            spec.license       = 'MIT'
            spec.required_ruby_version = '>= 3.4.0'
            spec.files = Dir['lib/**/*', 'exe/*', 'README.md', 'LICENSE', 'CHANGELOG.md']
            spec.bindir        = 'exe'
            spec.executables   = ['methodray']
            spec.require_paths = ['lib']
            spec.add_dependency 'rbs', '~> 3.0'
          end
          EOF
          gem build methodray-${{ matrix.ruby-platform }}.gemspec
          mkdir -p pkg
          mv *.gem pkg/

      - name: Upload gem artifact
        uses: actions/upload-artifact@v6
        with:
          name: gem-${{ matrix.ruby-platform }}
          path: pkg/*.gem

  build-source:
    name: Build source gem
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Build source gem
        run: |
          gem build methodray.gemspec
          mkdir -p pkg
          mv *.gem pkg/

      - name: Upload gem artifact
        uses: actions/upload-artifact@v6
        with:
          name: gem-source
          path: pkg/*.gem

  release:
    name: Release
    needs: [build-native, build-source]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Collect all gems
        run: |
          mkdir -p release
          find artifacts -name "*.gem" -exec cp {} release/ \;
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to RubyGems
        run: |
          mkdir -p ~/.gem
          echo -e "---\n:rubygems_api_key: ${{ secrets.GEM_HOST_API_KEY }}" > ~/.gem/credentials
          chmod 0600 ~/.gem/credentials
          for gem in release/*.gem; do
            echo "Pushing $gem..."
            gem push "$gem" || true
          done
